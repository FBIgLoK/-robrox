local player = game.Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local UserInputService = game:GetService("UserInputService")

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "MenuGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

local frame = Instance.new("Frame")
frame.Name = "MenuFrame"
frame.Size = UDim2.new(0, 700, 0, 420)
frame.AnchorPoint = Vector2.new(0.5, 0.5)
frame.Position = UDim2.new(0.5, 0, 0.5, 0)
frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
frame.BackgroundTransparency = 0.1
frame.BorderSizePixel = 0
frame.Parent = screenGui

local uiCorner = Instance.new("UICorner")
uiCorner.CornerRadius = UDim.new(0, 10)
uiCorner.Parent = frame

-- Drag functionality
local dragging = false
local dragStart = nil
local startPos = nil

frame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = frame.Position
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
			end
		end)
	end
end)

frame.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
		if dragging then
			local delta = input.Position - dragStart
			frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
		end
	end
end)

local title = Instance.new("TextLabel")
title.Name = "Title"
title.Text = "Fbi UwU HUB"
title.Size = UDim2.new(1, 0, 0, 40)
title.Position = UDim2.new(0, 0, 0, 0)
title.BackgroundTransparency = 1
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.SourceSansBold
title.TextSize = 24
title.TextScaled = false
title.Parent = frame

local thinLine = Instance.new("Frame")
thinLine.Name = "ThinLine"
thinLine.Size = UDim2.new(1, 0, 0, 2)
thinLine.Position = UDim2.new(0, 0, 0, 40)
thinLine.BackgroundColor3 = Color3.fromRGB(128, 0, 128) -- Purple
thinLine.BorderSizePixel = 0
thinLine.Parent = frame

-- Sidebar (botões de abas) e aba Perfil
local sidebar = Instance.new("Frame")
sidebar.Name = "Sidebar"
sidebar.Size = UDim2.new(0, 150, 1, -52)
sidebar.Position = UDim2.new(0, 0, 0, 52)
sidebar.BackgroundTransparency = 1
sidebar.Parent = frame

local perfilButton = Instance.new("TextButton")
perfilButton.Name = "PerfilButton"
perfilButton.Size = UDim2.new(1, -20, 0, 40)
perfilButton.Position = UDim2.new(0, 10, 0, 10)
perfilButton.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
perfilButton.BorderSizePixel = 0
perfilButton.TextColor3 = Color3.fromRGB(255, 255, 255)
perfilButton.Font = Enum.Font.SourceSans
perfilButton.TextSize = 20
perfilButton.Text = ""
perfilButton.TextXAlignment = Enum.TextXAlignment.Left

-- Container interno para alinhar ícone e texto horizontalmente
local contentHolder = Instance.new("Frame")
contentHolder.Name = "ContentHolder"
contentHolder.Size = UDim2.new(1, 0, 1, 0)
contentHolder.BackgroundTransparency = 1
contentHolder.Parent = perfilButton

local listLayout = Instance.new("UIListLayout")
listLayout.FillDirection = Enum.FillDirection.Horizontal
listLayout.VerticalAlignment = Enum.VerticalAlignment.Center
listLayout.Padding = UDim.new(0, 8)
listLayout.Parent = contentHolder

perfilButton.Parent = sidebar

-- Icone real (ImageLabel). Substitua o Image pelo seu asset id.
-- Icone como emoji (TextLabel) tintado de roxo
-- Icone construído com UI (círculo roxo + silhueta branca)
local iconFrame = Instance.new("Frame")
iconFrame.Name = "Icon"
iconFrame.Size = UDim2.new(0, 20, 0, 20)
iconFrame.BackgroundColor3 = Color3.fromRGB(128, 0, 128)
iconFrame.BorderSizePixel = 0
iconFrame.Parent = contentHolder

local iconCorner = Instance.new("UICorner")
iconCorner.CornerRadius = UDim.new(1, 0)
iconCorner.Parent = iconFrame

-- cabeça (círculo branco)
local head = Instance.new("Frame")
head.Name = "Head"
head.Size = UDim2.new(0, 7, 0, 7)
head.Position = UDim2.new(0.5, -3.5, 0.3, -3.5)
head.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
head.BorderSizePixel = 0
head.Parent = iconFrame

local headCorner = Instance.new("UICorner")
headCorner.CornerRadius = UDim.new(1, 0)
headCorner.Parent = head

-- corpo (retângulo branco arredondado)
local body = Instance.new("Frame")
body.Name = "Body"
body.Size = UDim2.new(0, 10, 0, 5)
body.Position = UDim2.new(0.5, -5, 0.65, -2.5)
body.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
body.BorderSizePixel = 0
body.Parent = iconFrame

local bodyCorner = Instance.new("UICorner")
bodyCorner.CornerRadius = UDim.new(0, 3)
bodyCorner.Parent = body

-- ZIndex (garante que o ícone fique acima do fundo do botão)
iconFrame.ZIndex = 3
head.ZIndex = 4
body.ZIndex = 4

-- Texto interno do botão (agora controlado por um TextLabel filho)
local perfilText = Instance.new("TextLabel")
perfilText.Name = "PerfilText"
perfilText.Size = UDim2.new(1, -28, 1, 0)
perfilText.BackgroundTransparency = 1
perfilText.Text = "Perfil"
perfilText.TextColor3 = Color3.fromRGB(255, 255, 255)
perfilText.Font = Enum.Font.SourceSans
perfilText.TextSize = 20
perfilText.TextXAlignment = Enum.TextXAlignment.Left
perfilText.Parent = contentHolder

local content = Instance.new("Frame")
content.Name = "Content"
content.Size = UDim2.new(1, -150, 1, -52)
content.Position = UDim2.new(0, 150, 0, 52)
content.BackgroundTransparency = 1
content.Parent = frame

-- Separador vertical entre sidebar e área de conteúdo
local separator = Instance.new("Frame")
separator.Name = "Separator"
separator.Size = UDim2.new(0, 2, 1, -52)
separator.Position = UDim2.new(0, 150, 0, 52)
separator.BackgroundColor3 = Color3.fromRGB(128, 0, 128)
separator.BorderSizePixel = 0
separator.Parent = frame

local perfilTab = Instance.new("Frame")
perfilTab.Name = "PerfilTab"
perfilTab.Size = UDim2.new(1, 0, 1, 0)
perfilTab.BackgroundTransparency = 1
perfilTab.Visible = false
perfilTab.Parent = content
	if espTab then espTab.Visible = false end

-- Botão ESP abaixo do Perfil
local espButton = Instance.new("TextButton")
espButton.Name = "ESPButton"
espButton.Size = UDim2.new(1, -20, 0, 40)
espButton.Position = UDim2.new(0, 10, 0, 60)
espButton.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
espButton.BorderSizePixel = 0
espButton.TextColor3 = Color3.fromRGB(255, 255, 255)
espButton.Font = Enum.Font.SourceSans
espButton.TextSize = 20
espButton.Text = ""
espButton.TextXAlignment = Enum.TextXAlignment.Left
espButton.Parent = sidebar

local espHolder = Instance.new("Frame")
espHolder.Name = "ESPHolder"
espHolder.Size = UDim2.new(1, 0, 1, 0)
espHolder.BackgroundTransparency = 1
espHolder.Parent = espButton

local espLayout = Instance.new("UIListLayout")
espLayout.FillDirection = Enum.FillDirection.Horizontal
espLayout.VerticalAlignment = Enum.VerticalAlignment.Center
espLayout.Padding = UDim.new(0, 8)
espLayout.Parent = espHolder

local espIconFrame = Instance.new("Frame")
espIconFrame.Name = "Icon"
espIconFrame.Size = UDim2.new(0, 20, 0, 20)
espIconFrame.BackgroundColor3 = Color3.fromRGB(128, 0, 128)
espIconFrame.BorderSizePixel = 0
espIconFrame.Parent = espHolder

local espIconCorner = Instance.new("UICorner")
espIconCorner.CornerRadius = UDim.new(1, 0)
espIconCorner.Parent = espIconFrame

local espText = Instance.new("TextLabel")
espText.Name = "ESPText"
espText.Size = UDim2.new(1, -28, 1, 0)
espText.BackgroundTransparency = 1
espText.Text = "ESP"
espText.TextColor3 = Color3.fromRGB(255, 255, 255)
espText.Font = Enum.Font.SourceSans
espText.TextSize = 20
espText.TextXAlignment = Enum.TextXAlignment.Left
espText.Parent = espHolder

-- (espButton click handler será definido após criar os toggles)

-- Aba ESP (onde ficarão os toggles)
local espTab = Instance.new("Frame")
espTab.Name = "ESPTab"
espTab.Size = UDim2.new(1, 0, 1, 0)
espTab.BackgroundTransparency = 1
espTab.Visible = false
espTab.Parent = content

local espTitle = Instance.new("TextLabel")
espTitle.Name = "ESPTitle"
espTitle.Text = "ESP Settings"
espTitle.Size = UDim2.new(1, -20, 0, 30)
espTitle.Position = UDim2.new(0, 10, 0, 10)
espTitle.BackgroundTransparency = 1
espTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
espTitle.Font = Enum.Font.SourceSans
espTitle.TextSize = 20
espTitle.Parent = espTab

-- Helper to create a simple toggle row
local function createToggleRow(parent, y, labelText, varName, updateFuncName)
	local row = Instance.new("Frame")
	row.Size = UDim2.new(1, -20, 0, 36)
	row.Position = UDim2.new(0, 10, 0, y)
	row.BackgroundTransparency = 1
	row.Parent = parent

	local lbl = Instance.new("TextLabel")
	lbl.Name = "Label"
	lbl.Size = UDim2.new(1, -70, 1, 0)
	lbl.BackgroundTransparency = 1
	lbl.Text = labelText
	lbl.TextColor3 = Color3.fromRGB(255,255,255)
	lbl.Font = Enum.Font.SourceSans
	lbl.TextSize = 18
	lbl.TextXAlignment = Enum.TextXAlignment.Left
	lbl.Parent = row

	local toggle = Instance.new("TextButton")
	toggle.Name = "Toggle"
	toggle.Size = UDim2.new(0, 50, 0, 24)
	toggle.Position = UDim2.new(1, -60, 0.5, -12)
	toggle.BackgroundColor3 = Color3.fromRGB(60,60,60)
	toggle.BorderSizePixel = 0
	toggle.Parent = row

	local knob = Instance.new("Frame")
	knob.Name = "Knob"
	knob.Size = UDim2.new(0, 20, 0, 20)
	knob.Position = UDim2.new(0, 2, 0.5, -10)
	knob.BackgroundColor3 = Color3.fromRGB(200,200,200)
	knob.BorderSizePixel = 0
	knob.Parent = toggle

	local function updateVisual(state)
		if state then
			toggle.BackgroundColor3 = Color3.fromRGB(0, 170, 85)
			knob.Position = UDim2.new(1, -22, 0.5, -10)
			knob.BackgroundColor3 = Color3.fromRGB(255,255,255)
		else
			toggle.BackgroundColor3 = Color3.fromRGB(60,60,60)
			knob.Position = UDim2.new(0, 2, 0.5, -10)
			knob.BackgroundColor3 = Color3.fromRGB(200,200,200)
		end
	end

	-- initialize from existing globals if present
	local initState = false
	if _G[varName] ~= nil then initState = _G[varName] end
	updateVisual(initState)

	toggle.MouseButton1Click:Connect(function()
		initState = not initState
		_G[varName] = initState
		updateVisual(initState)
		-- call update function if exists
		if updateFuncName and type(_G[updateFuncName]) == "function" then
			pcall(_G[updateFuncName])
		end
	end)
end

-- Function to update Master ESP
_G.UpdateMasterESP = function()
	if _G.MasterESP then
		-- Enable ESP
		local existingGui = game.Players.LocalPlayer:WaitForChild("PlayerGui"):FindFirstChild("ESP_GUI")
		if existingGui then existingGui:Destroy() end

		-- Serviços
		local Players = game:GetService("Players")
		local RunService = game:GetService("RunService")
		local localPlayer = Players.LocalPlayer
		local camera = workspace.CurrentCamera

		-- Criar ScreenGui caso não exista
		local screenGui = Instance.new("ScreenGui")
		screenGui.Name = "ESP_GUI"
		screenGui.Parent = localPlayer:WaitForChild("PlayerGui")

		-- Função que cria ESP pra cada player
		local function createESP(player)
			-- Criar Frame da box
			local box = Instance.new("Frame")
			box.Name = "ESP_Box_" .. player.Name
			box.Size = UDim2.new(0, 50, 0, 100)  -- tamanho inicial
			box.BorderSizePixel = 2
			box.BackgroundTransparency = 0.7
			box.BorderColor3 = Color3.fromRGB(255,0,0)
			box.Parent = screenGui

			-- Criar nome acima da box
			local nameLabel = Instance.new("TextLabel")
			nameLabel.Name = "ESP_Name_" .. player.Name
			nameLabel.Size = UDim2.new(1,0,0,20)
			nameLabel.Position = UDim2.new(0,0,-20,0)
			nameLabel.BackgroundTransparency = 1
			nameLabel.TextColor3 = Color3.fromRGB(255,255,255)
			nameLabel.TextStrokeTransparency = 0
			nameLabel.TextScaled = true
			nameLabel.Text = player.Name
			nameLabel.Parent = box

			-- Atualizar posição todo frame
			RunService.RenderStepped:Connect(function()
				if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
					local character = player.Character
					local humanoidRootPart = character.HumanoidRootPart

					-- Calcular bounding box do personagem
					local minY = math.huge
					local maxY = -math.huge
					local minX = math.huge
					local maxX = -math.huge

					for _, part in pairs(character:GetChildren()) do
						if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" then
							local corners = {
								part.CFrame * CFrame.new(-part.Size.X/2, -part.Size.Y/2, -part.Size.Z/2),
								part.CFrame * CFrame.new(part.Size.X/2, -part.Size.Y/2, -part.Size.Z/2),
								part.CFrame * CFrame.new(-part.Size.X/2, part.Size.Y/2, -part.Size.Z/2),
								part.CFrame * CFrame.new(part.Size.X/2, part.Size.Y/2, -part.Size.Z/2),
								part.CFrame * CFrame.new(-part.Size.X/2, -part.Size.Y/2, part.Size.Z/2),
								part.CFrame * CFrame.new(part.Size.X/2, -part.Size.Y/2, part.Size.Z/2),
								part.CFrame * CFrame.new(-part.Size.X/2, part.Size.Y/2, part.Size.Z/2),
								part.CFrame * CFrame.new(part.Size.X/2, part.Size.Y/2, part.Size.Z/2)
							}

							for _, corner in pairs(corners) do
								local screenPos = camera:WorldToViewportPoint(corner.Position)
								minX = math.min(minX, screenPos.X)
								maxX = math.max(maxX, screenPos.X)
								minY = math.min(minY, screenPos.Y)
								maxY = math.max(maxY, screenPos.Y)
							end
						end
					end

					if minX < math.huge then
						local width = maxX - minX
						local height = maxY - minY

						box.Size = UDim2.new(0, width, 0, height)
						box.Position = UDim2.new(0, minX, 0, minY)
						box.Visible = true
					else
						box.Visible = false
					end
				else
					box.Visible = false
				end
			end)
		end

		-- Criar ESP para todos os players existentes
		for _, player in pairs(Players:GetPlayers()) do
			createESP(player)
		end

		-- Criar ESP para players que entrarem depois
		Players.PlayerAdded:Connect(function(player)
			player.CharacterAdded:Connect(function()
				createESP(player)
			end)
		end)
	else
		-- Disable ESP
		local existingGui = game.Players.LocalPlayer:WaitForChild("PlayerGui"):FindFirstChild("ESP_GUI")
		if existingGui then existingGui:Destroy() end
	end
end

-- Master ESP Toggle
createToggleRow(espTab, 50, "Master ESP", "MasterESP", "UpdateMasterESP")

-- agora conecta o clique do botão ESP (depois de a aba existir)
espButton.MouseButton1Click:Connect(function()
	espTab.Visible = true
	perfilTab.Visible = false
end)

local perfilLabel = Instance.new("TextLabel")
perfilLabel.Name = "PerfilLabel"
perfilLabel.Text = "Bem-vindo ao seu Perfil"
perfilLabel.Size = UDim2.new(1, -20, 0, 30)
perfilLabel.Position = UDim2.new(0, 10, 0, 10)
perfilLabel.BackgroundTransparency = 1
perfilLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
perfilLabel.Font = Enum.Font.SourceSans
perfilLabel.TextSize = 20
perfilLabel.Parent = perfilTab

perfilButton.MouseButton1Click:Connect(function()
		-- mostra só a aba Perfil, esconde a aba ESP
		if espTab then espTab.Visible = false end
		perfilTab.Visible = true
end)
