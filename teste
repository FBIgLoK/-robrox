local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

local AIM_PART = "Head"
local MAX_DISTANCE = 2000

-- Raycast params
local rayParams = RaycastParams.new()
rayParams.FilterType = Enum.RaycastFilterType.Blacklist
rayParams.IgnoreWater = true

-- verifica se o alvo está visível (sem parede)
local function isVisible(targetPart)
	local origin = Camera.CFrame.Position
	local direction = (targetPart.Position - origin)

	rayParams.FilterDescendantsInstances = {
		LocalPlayer.Character,
		targetPart.Parent
	}

	local rayResult = Workspace:Raycast(origin, direction, rayParams)

	if rayResult then
		-- se bateu em algo que NÃO é o player, tem parede
		if not rayResult.Instance:IsDescendantOf(targetPart.Parent) then
			return false
		end
	end

	return true
end

-- pega o player mais próximo VISÍVEL
local function getClosestVisiblePlayer()
	local closestTarget = nil
	local shortestDistance = math.huge

	local myChar = LocalPlayer.Character
	if not myChar then return nil end

	local myRoot = myChar:FindFirstChild("HumanoidRootPart")
	if not myRoot then return nil end

	for _, player in pairs(Players:GetPlayers()) do
		if player ~= LocalPlayer and player.Character then
			local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
			local root = player.Character:FindFirstChild("HumanoidRootPart")
			local head = player.Character:FindFirstChild(AIM_PART)

			if humanoid and humanoid.Health > 0 and root and head then
				local distance = (root.Position - myRoot.Position).Magnitude

				if distance < shortestDistance and distance <= MAX_DISTANCE then
					if isVisible(head) then
						shortestDistance = distance
						closestTarget = head
					end
				end
			end
		end
	end

	return closestTarget
end

-- LOOP PRINCIPAL
RunService.RenderStepped:Connect(function()
	local targetHead = getClosestVisiblePlayer()
	if targetHead then
		local camPos = Camera.CFrame.Position
		Camera.CFrame = CFrame.new(camPos, targetHead.Position)
	end
end)
