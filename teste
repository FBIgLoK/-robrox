-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera

local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

-- CONFIG
local AIM_KEY = Enum.UserInputType.MouseButton2 -- botão direito
local AIM_PART = "Head"
local SMOOTHNESS = 0.15
local FOV_RADIUS = 120

local aiming = false

-- FOV CIRCLE
local fov = Drawing.new("Circle")
fov.Color = Color3.fromRGB(255, 255, 255)
fov.Thickness = 2
fov.NumSides = 100
fov.Radius = FOV_RADIUS
fov.Filled = false
fov.Visible = true

-- INPUT
UserInputService.InputBegan:Connect(function(input)
	if input.UserInputType == AIM_KEY then
		aiming = true
	end
end)

UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType == AIM_KEY then
		aiming = false
	end
end)

-- FUNÇÃO: pegar alvo mais próximo do centro
local function getClosestTarget()
	local closestPlayer = nil
	local shortestDistance = FOV_RADIUS

	for _, player in pairs(Players:GetPlayers()) do
		if player ~= LocalPlayer and player.Character then
			local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
			local part = player.Character:FindFirstChild(AIM_PART)

			if humanoid and humanoid.Health > 0 and part then
				local screenPos, onScreen = Camera:WorldToViewportPoint(part.Position)

				if onScreen then
					local dist = (Vector2.new(screenPos.X, screenPos.Y) - UserInputService:GetMouseLocation()).Magnitude

					if dist < shortestDistance then
						shortestDistance = dist
						closestPlayer = part
					end
				end
			end
		end
	end

	return closestPlayer
end

-- LOOP
RunService.RenderStepped:Connect(function()
	local mousePos = UserInputService:GetMouseLocation()
	fov.Position = mousePos

	if aiming then
		local target = getClosestTarget()

		if target then
			local camPos = Camera.CFrame.Position
			local aimCFrame = CFrame.new(camPos, target.Position)

			Camera.CFrame = Camera.CFrame:Lerp(aimCFrame, SMOOTHNESS)
		end
	end
end)
